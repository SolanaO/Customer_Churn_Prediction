<!DOCTYPE html><html><head>
      <title>Churn_Prediction_Report</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////home/silvia/.atom/packages/markdown-preview-enhanced/node_modules/@shd101wyy/mume/dependencies/katex/katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <h1 class="mume-header" id="user-activity-based-churn-prediction-with-pyspark-on-an-aws-emr-cluster">User Activity Based Churn Prediction With PySpark on an AWS-EMR Cluster</h1>

<h4 class="mume-header" id="silvia-onofrei"><em>Silvia Onofrei</em></h4>

<h6 class="mume-header" id="february-12-2022"><em>February 12, 2022</em></h6>

<p><br><br><br>
<img src="imgs/sparkify_songs.png" width="800" height="300"><br>
<br><br></p>
<ul>
<li><a href="#user-activity-based-churn-prediction-with-pyspark-on-an-aws-emr-cluster">User Activity Based Churn Prediction With PySpark on an AWS-EMR Cluster</a><br>
- <a href="#silvia-onofrei"><em>Silvia Onofrei</em></a><br>
- <a href="#february-12-2022"><em>February 12, 2022</em></a>
<ul>
<li><a href="#1-problem-overview">1. Problem Overview</a></li>
<li><a href="#2-problem-statement">2. Problem Statement</a></li>
<li><a href="#3-metrics">3. Metrics</a></li>
<li><a href="#4-implementation">4. Implementation</a></li>
<li><a href="#5-data-exploration">5. Data Exploration</a><br>
- <a href="#user-information">User information</a><br>
- <a href="#song-information">Song information</a><br>
- <a href="#log-information">Log information</a></li>
<li><a href="#6-data-cleaning-and-preprocessing">6. Data Cleaning and Preprocessing</a></li>
<li><a href="#7-feature-engineering">7. Feature Engineering</a></li>
<li><a href="#8-eda-on-engineered-features">8. EDA on Engineered Features</a></li>
<li><a href="#9-data-split">9. Data Split</a></li>
<li><a href="#10-feature-relevance">10. Feature Relevance</a></li>
<li><a href="#11-spot-check-classifiers">11. Spot Check Classifiers</a>
<ul>
<li><a href="#the-baseline-model">The Baseline Model</a></li>
<li><a href="#the-classifiers">The Classifiers</a></li>
<li><a href="#the-pipeline">The Pipeline</a></li>
<li><a href="#the-first-results">The First Results</a></li>
</ul>
</li>
<li><a href="#12-fine-tune-the-best-models">12. Fine Tune the Best Models</a>
<ul>
<li><a href="#fine-tune-multilayer-perceptron-classifier-mlpc">Fine Tune Multilayer Perceptron Classifier (MLPC)</a></li>
<li><a href="#fine-tune-gradient-boosted-trees-gbt">Fine Tune Gradient Boosted Trees (GBT)</a></li>
</ul>
</li>
<li><a href="#13-model-evaluation-and-validation">13. Model Evaluation and Validation</a></li>
<li><a href="#14-justification">14. Justification</a></li>
<li><a href="#15-reflection">15. Reflection</a></li>
<li><a href="#16-improvement">16. Improvement</a></li>
<li><a href="#17-ending-matters">17. Ending Matters</a></li>
</ul>
</li>
</ul>
<p>&#xA0;</p>
<h2 class="mume-header" id="1-problem-overview">1. Problem Overview</h2>

<p>The <em>churn rate</em>, also known as the rate of attrition or <em>customer churn</em>, is the rate at which customers stop doing business with an entity, see <a href="https://www.investopedia.com/terms/c/churnrate.asp">Investopedia</a>. A high churn rate causes problems to a business as it slows growth and decreases revenue. Churn prediction aims to detect which customers are most likely to leave a service or to cancel a subscription to a service. As the cost of acquiring new customers is higher than the cost of retaining the existing ones, detecting the churn customers and taking the appropriate measures is a critical task for many businesses.</p>
<p>It is imperative to identify the reasons the customers leave a service, and we must keep in mind that these reasons will vary from customer to customer. One of the tasks of a churn prediction algorithm is to identify common reasons for which customers would churn. This knowledge could benefit general marketing strategies which, combined with a personalized approach, will improve customer retention.</p>
<p>A quick internet check for the customer churn topic returns numerous links to blogs and online services that analyze the reasons customer churn happens and how to address it. Here is a link to a blog by <a href="https://heap.io/topics/master-customer-churn-and-massively-improve-retention">Heap</a>, a digital insights platform, that addresses the issue of customer churn.</p>
<p>There are various formulas to calculate the churn, see this <a href="https://www.profitwell.com/customer-churn/calculate-churn-rate">Ultimate Guide to Churn Rate</a> for a discussion of four such formulas, which mostly depend on how the number of customers is evaluated. We will adopt a <em>simple way</em> to compute the churn rate as the proportion of churned customers over the period of time the data was collected.</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mstyle mathsize="0.9em"><mi mathvariant="normal">C</mi><mi mathvariant="normal">h</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">n</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">R</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mstyle><mo>=</mo><mfrac><mstyle mathsize="0.9em"><mi mathvariant="normal">N</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">c</mi><mi mathvariant="normal">h</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">d</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">c</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">s</mi></mstyle><mstyle mathsize="0.9em"><mi mathvariant="normal">T</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">l</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">n</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">c</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">s</mi></mstyle></mfrac></mrow><annotation encoding="application/x-tex">{\rm \small Churn \; Rate} = \frac{\rm \small Number\; of\; churned \; customers}{\rm \small Total\; number\; of \; customers}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.624996em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5">Churn</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">Rate</span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.9879959999999999em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.301996em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5">Total</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">number</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5" style="margin-right:0.07778em;">of</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">customers</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5">Number</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5" style="margin-right:0.07778em;">of</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">churned</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">customers</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<br>
<p>Predicting churn is highly relevant to online subscription platforms:</p>
<ul>
<li>it helps businesses to have a better understanding of future expected revenue, and</li>
<li>it allows to identify those users with higher risk of churn and attempt to prevent them from cancelling the subscription.</li>
</ul>
<p>&#xA0;</p>
<h2 class="mume-header" id="2-problem-statement">2. Problem Statement</h2>

<p>In the present project, we are analyzing and predicting churn for a fictional music platform Sparkify. The dataset is made available by the online learning platform <a href="https://www.udacity.com/">Udacity</a> within the Data Scientist Nanodegree. The full dataset is about <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn></mrow><annotation encoding="application/x-tex">12</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">12</span></span></span></span> GB and consists of more than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>26</mn></mrow><annotation encoding="application/x-tex">26</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">26</span></span></span></span> million records; a <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>128</mn></mrow><annotation encoding="application/x-tex">128</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">128</span></span></span></span> MB sample dataset with about <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>265000</mn></mrow><annotation encoding="application/x-tex">265 000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">265000</span></span></span></span> records is available for local analysis.</p>
<p>To succeed at retaining customers, the Marketing Department at Sparkify must be able to predict which customers are most likely to churn.</p>
<p>With this goal in mind, the user log activity over a period of time is analyzed in order to predict which customers are most likely to cancel their service. This information will allow us to extrapolate on this data to identify future potential churn. The churn customers are identified when they choose the <code>Submit Cancellation</code> page in the service; with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> denoting <em>churned</em> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> as <em>not-churned</em>  for the target variable <code>churn</code>.</p>
<p>This is a <em>Supervised Machine Learning</em> problem since we are working with labelled data, and also a <em>binary classification problem</em> as each subscriber will be categorized as churn or not-churn. The approach is offline since the data is static, it was collected over a period of several months and it does not receive new records.</p>
<p>After an initial investigation of the dataset, we aim at creating features that describe best the level of involvement and satisfaction of the customers with the music platform. Some of these features are standard such as: subscription status (<em>free</em> or <em>paid</em>), length of time of the subscription or number of songs played. In addition, other factors, such as involvement in the online community (number of friends) and the level of satisfaction with the songs collection (<code>ThumbsUp</code> or <code>ThumbsDown</code>) are also taken into account when building the model. Our goal is to spot patterns in the way the customers churn. Since we do not have enough information to identify reasons for involuntary churn, we will assume that all the churn we are dealing with is voluntary.</p>
<p>Once the relevant features are identified and engineered, several models are trained in order to determine the ones with the best performance. The classifiers used are: Logistic Regression (LR), Decision Trees (DT), Random Forest (RF), Gradient Bosted Trees (GBT), MultiLayer Perceptron Classifiers (MLPC) and Linear Support Vector Classifier (LSCV). Among these, GBT and MLPC performed the best and they are fine-tuned by running a grid search with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn></mrow><annotation encoding="application/x-tex">5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span></span></span></span>-fold cross validation. The best models and their errors are analyzed.</p>
<p>&#xA0;</p>
<h2 class="mume-header" id="3-metrics">3. Metrics</h2>

<p>The acceptable percentage of churn varies greatly among industries, but we expect the dataset to be imbalanced with respect to churn vs. not-churn users; you may find more specific considerations in this <a href="https://www.cobloom.com/blog/churn-rate-how-high-is-too-high#">article</a>. When data is imbalanced it is better to replace the accuracy score with other binary classification metrics such as: precision, recall and F1-score, the PR (precision - recall) and ROC (receiver operating characteristic) curves and the corresponding areas under curves PR-AUC and ROC-AUC; see this <a href="https://neptune.ai/blog/f1-score-accuracy-roc-auc-pr-auc">neptuneblog</a> for a great overview.</p>
<p>We use the following notation (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> represents churn, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> is for not-churn):</p>
<ul>
<li>tp - number of true positives (1 is predicted as a 1)</li>
<li>fp - number of false positives (0 is predicted as a 1)</li>
<li>tn - number of true negatives (0 is predicted as a 0)</li>
<li>fn - number of false negatives (1 is predicted as a 0)</li>
</ul>
<p><strong>Accuracy</strong> is a measure of how often the classifier is correct, and it is the fraction of correctly labeled users among all the users.</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mstyle mathsize="0.9em"><mi mathvariant="normal">A</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">y</mi></mstyle><mo>=</mo><mfrac><mstyle mathsize="0.9em"><mi mathvariant="normal">t</mi><mi mathvariant="normal">p</mi><mo>+</mo><mi mathvariant="normal">t</mi><mi mathvariant="normal">n</mi></mstyle><mstyle mathsize="0.9em"><mi mathvariant="normal">t</mi><mi mathvariant="normal">p</mi><mo>+</mo><mi mathvariant="normal">t</mi><mi mathvariant="normal">n</mi><mo>+</mo><mi mathvariant="normal">f</mi><mi mathvariant="normal">p</mi><mo>+</mo><mi mathvariant="normal">f</mi><mi mathvariant="normal">n</mi></mstyle></mfrac><mo>=</mo><mfrac><mstyle mathsize="0.9em"><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">y</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">i</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">d</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">c</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">s</mi></mstyle><mstyle mathsize="0.9em"><mi mathvariant="normal">a</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">l</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">c</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">s</mi></mstyle></mfrac></mrow><annotation encoding="application/x-tex">{\rm \small Accuracy} = \frac{\rm \small tp+tn}{\rm \small tp+tn+fp+fn}
  = \frac{\rm \small correctly \; identified \; customers}{\rm \small all \; customers}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7899930000000001em;vertical-align:-0.174996em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5" style="margin-right:0.01389em;">Accuracy</span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.091568em;vertical-align:-0.8609960000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.230572em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5">tp</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin sizing reset-size6 size5">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathrm sizing reset-size6 size5">tn</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin sizing reset-size6 size5">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathrm sizing reset-size6 size5">fp</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin sizing reset-size6 size5">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathrm sizing reset-size6 size5">fn</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5">tp</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin sizing reset-size6 size5">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathrm sizing reset-size6 size5">tn</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.8609960000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.9879959999999999em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.301996em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5">all</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">customers</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5" style="margin-right:0.01389em;">correctly</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">identified</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">customers</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<br>
<p><em>&quot;Considering a user preference towards the minority (positive) class examples, accuracy is not suitable because the impact of the least represented, but more important examples, is reduced when compared to that of the majority class.&quot;</em> - <a href="https://arxiv.org/pdf/1505.01658.pdf">Branco, Torgo, Ribeiro (2015)</a>.</p>
<br>
<p><strong>Precision</strong> is a measure of exactness, it is the ratio of correctly identified churn users to all the users that are labeled churn.</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mstyle mathsize="0.9em"><mi mathvariant="normal">P</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mstyle><mo>=</mo><mfrac><mstyle mathsize="0.9em"><mi mathvariant="normal">t</mi><mi mathvariant="normal">p</mi></mstyle><mstyle mathsize="0.9em"><mi mathvariant="normal">t</mi><mi mathvariant="normal">p</mi><mo>+</mo><mi mathvariant="normal">f</mi><mi mathvariant="normal">p</mi></mstyle></mfrac><mo>=</mo><mfrac><mstyle mathsize="0.9em"><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">y</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">i</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">d</mi><mtext>&#xA0;</mtext><mi mathvariant="normal">c</mi><mi mathvariant="normal">h</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">n</mi></mstyle><mstyle mathsize="0.9em"><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">y</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">i</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">d</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">c</mi><mi mathvariant="normal">h</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">n</mi><mo>+</mo><mi mathvariant="normal">i</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">y</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">d</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">a</mi><mi mathvariant="normal">s</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">c</mi><mi mathvariant="normal">h</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">n</mi></mstyle></mfrac></mrow><annotation encoding="application/x-tex">{\rm \small Precision} = \frac{\rm \small tp}{\rm \small tp + fp} =
\frac{\rm \small correctly \; identified \ churn}{\rm \small correctly \; identified \; churn +
incorrectly \; labeled \; as \;churn}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.614997em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5">Precision</span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.091568em;vertical-align:-0.8609960000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.230572em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5">tp</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin sizing reset-size6 size5">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathrm sizing reset-size6 size5">fp</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5">tp</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.8609960000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.162992em;vertical-align:-0.8609960000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.301996em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5" style="margin-right:0.01389em;">correctly</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">identified</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">churn</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin sizing reset-size6 size5">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathrm sizing reset-size6 size5" style="margin-right:0.01389em;">incorrectly</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">labeled</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">as</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">churn</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5" style="margin-right:0.01389em;">correctly</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">identified</span><span class="mspace sizing reset-size6 size5">&#xA0;</span><span class="mord mathrm sizing reset-size6 size5">churn</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.8609960000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<br>
<p><strong>Recall (sensitivity, true positive rate)</strong> is a measure of completeness, it is the fraction of churn users correctly identified as churn to all the users that churn.</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mstyle mathsize="0.9em"><mi mathvariant="normal">R</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">l</mi></mstyle><mo>=</mo><mfrac><mstyle mathsize="0.9em"><mi mathvariant="normal">t</mi><mi mathvariant="normal">p</mi></mstyle><mstyle mathsize="0.9em"><mi mathvariant="normal">t</mi><mi mathvariant="normal">p</mi><mo>+</mo><mi mathvariant="normal">f</mi><mi mathvariant="normal">n</mi></mstyle></mfrac><mo>=</mo><mfrac><mstyle mathsize="0.9em"><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">y</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">i</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">d</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">c</mi><mi mathvariant="normal">h</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">n</mi></mstyle><mstyle mathsize="0.9em"><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">y</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">i</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">d</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">c</mi><mi mathvariant="normal">h</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">n</mi><mo>+</mo><mi mathvariant="normal">i</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">y</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">d</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">a</mi><mi mathvariant="normal">s</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">n</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">t</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">c</mi><mi mathvariant="normal">h</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">n</mi></mstyle></mfrac></mrow><annotation encoding="application/x-tex">{\rm \small Recall} = \frac{\rm \small tp}{\rm \small tp + fn} =
\frac{\rm \small correctly \; identified \; churn}
{\rm \small correctly \; identified \; churn + incorrectly \; labeled \; as \; not \; churn}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.624996em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5">Recall</span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.091568em;vertical-align:-0.8609960000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.230572em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5">tp</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin sizing reset-size6 size5">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathrm sizing reset-size6 size5">fn</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5">tp</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.8609960000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.162992em;vertical-align:-0.8609960000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.301996em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5" style="margin-right:0.01389em;">correctly</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">identified</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">churn</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin sizing reset-size6 size5">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathrm sizing reset-size6 size5" style="margin-right:0.01389em;">incorrectly</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">labeled</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">as</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">not</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">churn</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5" style="margin-right:0.01389em;">correctly</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">identified</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">churn</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.8609960000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>Recall is a relevant metric in our case as we are trying to minimize the number of false negatives, i.e. the users that churn but are not identified as such.</p>
<br>
<p>Since the precision and the recall exhibit a trade-off, it is preferable to use the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">F</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf F_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83611em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathbf">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><strong>-score</strong> which is the harmonic mean of the two:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>F</mi><mn>1</mn></msub><mo>=</mo><mn>2</mn><mo>&#x22C5;</mo><mfrac><mstyle mathsize="0.9em"><mi mathvariant="normal">p</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mtext>&#x2005;&#x200A;</mtext><mo>&#x22C5;</mo><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">l</mi></mstyle><mstyle mathsize="0.9em"><mi mathvariant="normal">p</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mo>+</mo><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">l</mi></mstyle></mfrac><mo>=</mo><mfrac><mstyle mathsize="0.9em"><mi mathvariant="normal">t</mi><mi mathvariant="normal">p</mi></mstyle><mstyle mathsize="0.9em"><mi mathvariant="normal">t</mi><mi mathvariant="normal">p</mi><mo>+</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo stretchy="false">(</mo><mi mathvariant="normal">f</mi><mi mathvariant="normal">n</mi><mo>+</mo><mi mathvariant="normal">f</mi><mi mathvariant="normal">p</mi><mo stretchy="false">)</mo></mstyle></mfrac></mrow><annotation encoding="application/x-tex">F_1 = 2 \cdot \frac{\rm \small precision \; \cdot \; recall}{\rm \small precision + recall} = \frac{\rm \small tp}{\rm \small tp + \frac{1}{2}(fn+fp)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x22C5;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.162992em;vertical-align:-0.8609960000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.301996em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5">precision</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin sizing reset-size6 size5">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathrm sizing reset-size6 size5">recall</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5">precision</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin sizing reset-size6 size5">&#x22C5;</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathrm sizing reset-size6 size5">recall</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.8609960000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.227072em;vertical-align:-0.9965em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.230572em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5">tp</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin sizing reset-size6 size5">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord sizing reset-size6 size5"><span class="mopen nulldelimiter sizing reset-size5 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8236266666666667em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size5 size2 mtight"><span class="mord mtight"><span class="mord mathrm mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size5 size2 mtight"><span class="mord mtight"><span class="mord mathrm mtight">1</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size5 size6"></span></span><span class="mopen sizing reset-size6 size5">(</span><span class="mord mathrm sizing reset-size6 size5">fn</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin sizing reset-size6 size5">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathrm sizing reset-size6 size5">fp</span><span class="mclose sizing reset-size6 size5">)</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5">tp</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.9965em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>The <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">F_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>-score is more informative on the classifier&apos;s performance than its two counterparts. It weights the two metrics (precision and recall) in a balanced way, requiring both to have higher values for the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">F_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>-score to be high.</p>
<br>
<p>In addition to the above four metrics we will also compute the ROC-AUC and PR-AUC scores, often used in classification problems with imbalanced sets.</p>
<p>The <strong>ROC</strong> (receiver operating characteristic) curve is a plot of false positive rate:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mstyle mathsize="0.9em"><mi mathvariant="normal">f</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">r</mi></mstyle><mo>=</mo><mfrac><mstyle mathsize="0.9em"><mi mathvariant="normal">f</mi><mi mathvariant="normal">p</mi></mstyle><mstyle mathsize="0.9em"><mi mathvariant="normal">f</mi><mi mathvariant="normal">p</mi><mo>+</mo><mi mathvariant="normal">t</mi><mi mathvariant="normal">n</mi></mstyle></mfrac><mo>=</mo><mfrac><mstyle mathsize="0.9em"><mi mathvariant="normal">i</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">y</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">d</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">a</mi><mi mathvariant="normal">s</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">c</mi><mi mathvariant="normal">h</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">n</mi></mstyle><mstyle mathsize="0.9em"><mi mathvariant="normal">i</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">y</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">d</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">a</mi><mi mathvariant="normal">s</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">c</mi><mi mathvariant="normal">h</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">n</mi><mo>+</mo><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">y</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">d</mi><mtext>&#x2005;&#x200A;</mtext><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">n</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">t</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">c</mi><mi mathvariant="normal">h</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">n</mi></mstyle></mfrac></mrow><annotation encoding="application/x-tex">{\rm \small fpr}  = \frac{\rm \small fp}{\rm \small fp + tn} =
\frac{\rm \small incorrectly \; labelled \; as \; churn}
{\rm \small incorrectly \; labelled \; as \; churn + correctly \; labeled \;  \; not \; churn}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.799992em;vertical-align:-0.174996em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5">fpr</span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.162992em;vertical-align:-0.8609960000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.301996em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5">fp</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin sizing reset-size6 size5">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathrm sizing reset-size6 size5">tn</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5">fp</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.8609960000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.162992em;vertical-align:-0.8609960000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.301996em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5" style="margin-right:0.01389em;">incorrectly</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">labelled</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">as</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">churn</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin sizing reset-size6 size5">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathrm sizing reset-size6 size5" style="margin-right:0.01389em;">correctly</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">labeled</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">not</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">churn</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm sizing reset-size6 size5" style="margin-right:0.01389em;">incorrectly</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">labelled</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">as</span><span class="mspace sizing reset-size6 size5" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm sizing reset-size6 size5">churn</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.8609960000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>on x-axis against the true positive rate (i.e. recall) on the y-axis, at different threshold values. The <strong>PR</strong> curve is a plot of the recall (on the x-axis) and precision (on the y-axis) for various threshold values. Since these curves do not provide single value performance scores, it is customarily to use <strong>AUC</strong>, area under the curve, as an evaluation metric which is in fact the average the function values over all possible thresholds. The closer these values are to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>, the better the classifier performs.</p>
<p><em>In those cases the dataset is heavily imbalanced and/or we mostly care about the positive class, it is recommended to use <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">F_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>-score and PR-AUC metric (see  <a href="https://neptune.ai/blog/f1-score-accuracy-roc-auc-pr-auc">neptuneblog</a> and <a href="https://learning.oreilly.com/library/view/hands-on-machine-learning/9781492032632/">A. Geron, Chp2, Sect. 4</a> for further details and considerations).</em></p>
<p>The ROC-AUC and PR-AUC are implemented in PySpark MLlib library. For convenience and uniform display of the results we built the following:</p>
 <img src="imgs/conf_mat_metrics.png" width="600" height="400">
<p>&#xA0;</p>
<blockquote>
<p>Given the data characteristics and the nature of the churn prediction problem we will keep our focus on the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">F_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>-score, with the goal of increasing the recall over precision, and on the PR-AUC score.</p>
</blockquote>
<p>&#xA0;</p>
<h2 class="mume-header" id="4-implementation">4. Implementation</h2>

<p>The project was implemented on an AWS-EMR cluster, using EMR Jupyter notebooks. To avoid creating very long notebooks, the project is split into three stages: data description, data wrangling and data modeling. Each stage is run on an AWS-EMR cluster which has configuration as described below.</p>
<ul>
<li>release label: emr-5.33.1,</li>
<li>Hadoop distribution: Amazon 2.10.1,</li>
<li>applications: Spark 2.4.7, Livy 0.7.0, JupyterHub 1.1.0, JupyterEnterpriseGateway 2.1.0,</li>
<li>1 master node (m5.xlarge) and 6 core nodes (m5.xlarge).</li>
</ul>
<p>In order to be able to install the SciPy libraries with the specified versions, I created a virtual environment on the cluster&apos;s master node using suggestions from this <a href="https://forums.aws.amazon.com/thread.jspa?messageID=989210&amp;tstart=0">AWS thread</a> and the following</p>
<ul>
<li>bootstrap actions: <code>emr_bootstrap.sh</code> as given below:</li>
</ul>
<pre data-role="codeBlock" data-info class="language-"><code>#!/bin/bash

python3 -m venv /home/hadoop/path/to/venv
source /home/hadoop/path/to/venv/bin/activate

set -x

python3 -m pip install --upgrade pip
pip3 freeze
pip3 install Cython==0.29.24
pip3 freeze
pip3 install numpy==1.21.2 -v
pip3 freeze
pip3 install pandas==1.3.3  -v
pip3 freeze
pip3 install matplotlib==3.4.3 -v
pip3 freeze
pip3 install seaborn==0.11.2 -v
pip3 freeze
pip3 install sklearn==0.0 -v
pip3 freeze

PYSPARK_PYTHON=/home/hadoop/path/to/venv/bin/python3
</code></pre><p>The above steps also require to include the following in the first cell of the notebook:</p>
<pre data-role="codeBlock" data-info class="language-"><code>%%configure -f
{&quot;conf&quot;: {&quot;spark.pyspark.python&quot;:&quot;/home/hadoop/path/to/venv/bin/python3&quot;}}
</code></pre><p>To ensure that the cluster has enough memory to perform all the tasks, and that it is not terminated prematurely I also adjusted the configuration settings (see <a href="https://towardsdatascience.com/how-to-set-up-a-cost-effective-aws-emr-cluster-and-jupyter-notebooks-for-sparksql-552360ffd4bc">this excellent blog</a> for more information), as detailed in the  <code>emr_configuration.json</code> file given below:</p>
<pre data-role="codeBlock" data-info class="language-"><code>[{&quot;classification&quot;:&quot;spark&quot;,
    &quot;properties&quot;:{
        &quot;spark.executor.memory&quot;: &quot;8g&quot;,
        &quot;spark.driver.memory&quot;: &quot;24g&quot;,
        &quot;spark.pyspark.virtualenv.enabled&quot;:&quot;true&quot;
        }
},
{&quot;classification&quot;:&quot;spark-defaults&quot;,
    &quot;properties&quot;:{
        &quot;spark.network.timeout&quot;:&quot;1500&quot;
        }
},
{&quot;classification&quot;:&quot;hdfs-site&quot;,
    &quot;properties&quot;:{
        &quot;dfs.replication&quot;:&quot;2&quot;
        }
},
{&quot;classification&quot;:&quot;livy-conf&quot;,
    &quot;properties&quot;:{
        &quot;livy.server.session.timeout&quot;:&quot;12h&quot;
        }
},
{&quot;classification&quot;:&quot;emrfs-site&quot;,
    &quot;properties&quot;:{
        &quot;fs.s3.maxConnections&quot;:&quot;100&quot;
        }
}]
</code></pre><p>Each stage of the project was completed in less than the expiration limit of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn></mrow><annotation encoding="application/x-tex">12</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">12</span></span></span></span> hours for the EMR notebook.</p>
<p>&#xA0;</p>
<h2 class="mume-header" id="5-data-exploration">5. Data Exploration</h2>

<p>The full dataset contains about <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>26</mn></mrow><annotation encoding="application/x-tex">26</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">26</span></span></span></span> millions log records that correspond to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>22278</mn></mrow><annotation encoding="application/x-tex">22278</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">22278</span></span></span></span> users. The sample dataset we used for preliminary investigation and code testing contains almost <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>300</mn></mrow><annotation encoding="application/x-tex">300</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">300</span></span></span></span> thousands records for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>226</mn></mrow><annotation encoding="application/x-tex">226</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">226</span></span></span></span> users.</p>
<p>There are <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>18</mn></mrow><annotation encoding="application/x-tex">18</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">18</span></span></span></span> features, their data types and brief descriptions are given in the table below.</p>
<img src="imgs/features_table.png" width="700" height="500">
<p><br><br></p>
<h4 class="mume-header" id="user-information">User information</h4>

<p>This group contains information such as <code>userId</code>, <code>firstName</code> and <code>lastName</code>, <code>gender</code> and  <code>location</code>.</p>
<ul>
<li>
<p>There are <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>22278</mn></mrow><annotation encoding="application/x-tex">22278</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">22278</span></span></span></span> unique <code>user_Id</code> which suggests that we have the records of the same number of users.</p>
</li>
<li>
<p>Among these users <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>51</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">51\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">51%</span></span></span></span> are male while <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>46</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">46\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">46%</span></span></span></span> are female, some users did not provide a F/M gender.</p>
</li>
<li>
<p>All the users are from US, they are from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn></mrow><annotation encoding="application/x-tex">100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">100</span></span></span></span> states and regions (groups of neighbor states). The distribution of the users among these states is very uneven, with California having the largest number of users.</p>
</li>
<li>
<p>The <code>userAgent</code> header is a characteristic string that lets servers and network peers identify the application, operating system, vendor, and/or version of the requesting user agent, for more information see <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/User-Agent">here</a>.</p>
</li>
<li>
<p>The  <code>level</code> column indicates the subscription status of the user (free or paid) and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>78</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">78\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">78%</span></span></span></span> of logs are by subscribed users (and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>80</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">80\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">80%</span></span></span></span> in the sample dataset)</p>
</li>
</ul>
<ul><ul><img src="imgs/levels.png" width="240" height="200" align="center">
</ul></ul>
<ul>
<li>From the <code>registration</code> feature we learn that the first user in the dataset registered in October <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2017</mn></mrow><annotation encoding="application/x-tex">2017</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2017</span></span></span></span> and the last user registration was recorded in December <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2018</mn></mrow><annotation encoding="application/x-tex">2018</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2018</span></span></span></span>.</li>
</ul>
<br>
<h4 class="mume-header" id="song-information">Song information</h4>

<ul>
<li>The columns <code>artist</code>, <code>song</code> and <code>length</code> refer to the songs played by the users from the collection available on the platform. The platform offers a little more that a quarter of millions of songs by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>38337</mn></mrow><annotation encoding="application/x-tex">38337</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">38337</span></span></span></span> artists, a reasonable collection.</li>
</ul>
<br>
<ul><img src="imgs/sparkify_artists.png" width="600" height="300" align="center"></ul>
<p><br><br></p>
<h4 class="mume-header" id="log-information">Log information</h4>

<p>This information refers to the activity of the user on the platform. There are several features that contain technical information on how the users log in:</p>
<ul>
<li>The features <code>method</code> (i.e. <a href="https://www.w3schools.com/tags/ref_httpmethods.asp">HTTP request method</a>), <code>status</code> (i.e. <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html">HTTP status code</a>) which is relevant because it points to error (code <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>404</mn></mrow><annotation encoding="application/x-tex">404</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">404</span></span></span></span>, which fortunately is quite rare, only <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">.</mi><mn>01</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">.01\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">.01%</span></span></span></span> of occurrences) and <code>auth</code> (which gives the authorization as <em>Logged In</em>, <em>Logged Out</em>, <em>Cancelled</em> or <em>Guest</em>).</li>
</ul>
<p>The features that contain actual log information are:</p>
<ul>
<li>
<p>The <code>sessionId</code>, <code>itemInSession</code> and <code>ts</code> all provide information about a specific session, in particular we can record how many steps a user took on the platform in one session (using <code>itemInSession</code> feature) and determine the time at which these actions were performed (via <code>ts</code> which stands for timestamp).</p>
</li>
<li>
<p>The sessions in the dataset were recorded between October <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>1</mn><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">t</mi></mrow></msup></mrow><annotation encoding="application/x-tex">1^{\rm st}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7935559999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">st</span></span></span></span></span></span></span></span></span></span></span></span></span> and December <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>1</mn><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">t</mi></mrow></msup><mo separator="true">,</mo><mn>2018</mn></mrow><annotation encoding="application/x-tex">1^{\rm st}, 2018</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9879959999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">st</span></span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2018</span></span></span></span>. Notice however that the small dataset has logs from March to November <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2018</mn></mrow><annotation encoding="application/x-tex">2018</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2018</span></span></span></span>.</p>
</li>
<li>
<p>There are about a quarter of million of unique sessions recorded. An interesting fact, as it can be seen from the barplot below: people listen more to music during the work week than over the weekend.</p>
</li>
</ul>
<ul><ul><ul><img src="imgs/sess_week.png" width="360" height="180" align="center">
</ul></ul></ul>
<ul>
<li>The <code>page</code> feature contains useful information about user&apos;s activity. There are <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>22</mn></mrow><annotation encoding="application/x-tex">22</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">22</span></span></span></span> page choices and the great majority is <em>NextSong</em> (more than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>20</mn></mrow><annotation encoding="application/x-tex">20</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">20</span></span></span></span> millions of log records out of the total of about <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>26</mn></mrow><annotation encoding="application/x-tex">26</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">26</span></span></span></span> millions of records).</li>
</ul>
<ul><ul><ul><img src="imgs/pages_full_data.png" width="300" height="400" align="center">
</ul></ul></ul>
<p>&#xA0;</p>
<h2 class="mume-header" id="6-data-cleaning-and-preprocessing">6. Data Cleaning and Preprocessing</h2>

<p>Missing values are found in:</p>
<ul>
<li>user information (first and last name, gender and location, userAgent),</li>
<li>song information (artist, song and length of the song).</li>
</ul>
<p>The full dataset does not have any missing <code>userId</code> records, but the sample dataset is missing about <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8000</mn></mrow><annotation encoding="application/x-tex">8000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8000</span></span></span></span> such records.</p>
<p>The following steps were performed for pre-processing for modeling.</p>
<p><u>Clean data</u>:</p>
<ul>
<li>remove the records where <code>userId</code> is the empty string;</li>
<li>drop columns not used in the modeling;</li>
<li>parse the timestamp columns <code>registration</code> and <code>ts</code> which were given in Unix time miliseconds to Unix time seconds.</li>
</ul>
<p><u>Preprocess data</u> - create features needed in modeling:</p>
<ul>
<li><code>firstevent_ts</code> (timestamp) - first time an user is active,</li>
<li><code>lastevent_ts</code> (timestamp) - last time a user is active,</li>
<li><code>reg_ts</code> (date type) - date from timestamp,</li>
<li><code>reg_date</code> (timestamp) - registration date,</li>
<li><code>init_days_interv</code> (int) - days between registration and first activity,</li>
<li><code>tenure_days_interv</code> (int) - days between registration and last activity,</li>
<li><code>active_days</code> (int) - days the user has some activity on the platform,</li>
<li><code>session_h</code> (float) - session&apos;s duration in hours.</li>
</ul>
<p>&#xA0;</p>
<h2 class="mume-header" id="7-feature-engineering">7. Feature Engineering</h2>

<p>The following new features are build for modeling:</p>
<ul>
<li>
<p><code>nr_songs</code> (int) - total number of songs user listened to,</p>
</li>
<li>
<p><code>nr_likes</code> (int) - total number of <em>Thumbs Up</em> of the user,</p>
</li>
<li>
<p><code>nr_dislikes</code> (int) - total number of <em>Thumbs Down</em> of the user,</p>
</li>
<li>
<p><code>nr_playlist</code> (int) - number of songs added to the playlist,</p>
</li>
<li>
<p><code>nr_friends</code> (int) - number of friends added through <em>Add Friend</em>,</p>
</li>
<li>
<p><code>nr_downgrades</code> (int) - total number of visits to <em>Downgrade</em> page by the user,</p>
</li>
<li>
<p><code>nr_upgrades</code> (int) - total number of visits to <em>Upgrade</em> page by the user,</p>
</li>
<li>
<p><code>nr_home</code> (int) - total number of visits to <em>Home</em> page by the user,</p>
</li>
<li>
<p><code>nr_error</code> (int) - total number of errors encountered by the user,</p>
</li>
<li>
<p><code>nr_settings</code> (int) - total number of visits to <em>Settings</em> page by the user,</p>
</li>
<li>
<p><code>nr_ads</code> (int) - total number of ads the user got,</p>
</li>
<li>
<p><code>nr_sessions</code> (int) - number of sessions of the user,</p>
</li>
<li>
<p><code>n_acts</code> (int) - total number of actions taken by the user,</p>
</li>
<li>
<p><code>avg_sess_h</code> (float) - average session length in hours,</p>
</li>
<li>
<p><code>acts_per_session</code> (float) - average number of actions per session for the user,</p>
</li>
<li>
<p><code>songs_per_session</code> (float) - average numer of songs listened per session by the user,</p>
</li>
<li>
<p><code>ads_per_session</code> (float) - average number of ads per session, received by user,</p>
</li>
<li>
<p><code>init_days_interv</code> (int) - time interval in days from registration to the first action of the user,</p>
</li>
<li>
<p><code>tenure_days_interv</code> (int) - time interval in days from registration to the last action of the user,</p>
</li>
<li>
<p><code>active_days</code> (int) - number of days the user was active on the platform,</p>
</li>
<li>
<p><code>gender</code> (binary) - 1 for F (female), 0 for M (male),</p>
</li>
<li>
<p><code>level</code> (binary) - 1 for paid, 0 for free.</p>
</li>
</ul>
<p>The column <code>churn</code> will be used as label for the model. We will use the <em>Cancellation Confirmation</em> page events to define it, which happen for both paid and free users.</p>
<ul>
<li><code>churn</code> (binary) - 1 for &quot;Cancellation Confirmation&quot; page visit, 0 otherwise.</li>
</ul>
<p>Once these features are created we have a new PySpark dataframe, with one row per user and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>23</mn></mrow><annotation encoding="application/x-tex">23</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">23</span></span></span></span> predictive features (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>20</mn></mrow><annotation encoding="application/x-tex">20</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">20</span></span></span></span> continuous and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span></span></span></span> discrete), the labels are contained in the <code>churn</code> column.</p>
<p>&#xA0;</p>
<h2 class="mume-header" id="8-eda-on-engineered-features">8. EDA on Engineered Features</h2>

<p>At this point we can visualize various distributions based on the <code>churn</code> level. Here are some takeouts from these visualizations:</p>
<ul>
<li>There is a higher percentage of churn customers among the free users vs. the paid users, which is expected, as these users did not actually commit to the service. Also, the churn is evenly distributed on genders.</li>
</ul>
<ul><ul><ul><img src="imgs/all_level_gender.png" width="360" height="180" align="center">
</ul></ul></ul>
<ul>
<li>Clearly, the people who choose to stay with the service listen to more songs than those who churn.</li>
</ul>
<ul><ul><ul><img src="imgs/songs_churn.png" width="360" height="240" align="center">
</ul></ul></ul>
<ul>
<li>The churn users receive more ads per session, and this might have created resentment towards the platform and could be considered as a reason to churn.</li>
</ul>
<ul><ul><ul><img src="imgs/ads_churn.png" width="360" height="320" align="center">
</ul></ul></ul>
<ul>
<li>The churn users are less engaged, they like fewer songs and tend to downgrade more - none of these is surprising.</li>
</ul>
<ul><ul><ul><img src="imgs/dislikes_churn.png" width="400" height="400" align="center">
</ul></ul></ul>
<ul>
<li>And again, we see that the churn users are less engaged in the platform features and activities, not only by listening to fewer songs but also having shorter saved playlists, fewer friends and fewer visits to the various pages on the platform.</li>
</ul>
<ul><ul><ul><img src="imgs/playlists_churn.png" width="800" height="360" align="left">
</ul></ul></ul>
<ul>
<li>We also take a look at the differences between the initial days interval (number of days between registration and the first time the user was active on the platform), the number of tenure days and the number of days the user was active on the platform. We notice that the users who did not churn have longer tenure on the platform and more active days than the churn users.</li>
</ul>
<ul><ul><ul><img src="imgs/interval_days.png" width="700" height="320" align="center">
</ul></ul></ul>
<p>&#xA0;</p>
<p>What we learn from the above observations is that the churn customers are less engaged in the platform, they use fewer features and they receive more ads per session. Sparkify&apos;s Customer Service could take these observations into account when trying to minimize the number of users who churn. Reducing the number of ads per session is easier than finding ways to engage the users.</p>
<p>&#xA0;</p>
<blockquote>
<p>It is easy to see from the above plots, that there are numerous outliers in almost every feature. Removing these outliers could improve the performance, but in the same time it has the potential of transforming weak effects into statistically significant ones. On a different note, given that the data reflects users&apos; activity, the outliers could provide useful insight into the preferences of certain groups of users. Hence, we will keep the outliers for now.</p>
</blockquote>
<p>&#xA0;</p>
<h2 class="mume-header" id="9-data-split">9. Data Split</h2>

<p>The dataset is highly imbalanced, and in order o ensure that the train set and the test set preserve the classes percentages we perform a stratified split (not available in PySpark as such), and set aside <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>30</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">30 \%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">30%</span></span></span></span> of the data for testing.</p>
<ul><ul><ul><img src="imgs/split_data.png" width="600" height="400" align="center">
</ul></ul></ul>
<p>&#xA0;</p>
<h2 class="mume-header" id="10-feature-relevance">10. Feature Relevance</h2>

<p>We estimate the feature relevance as the normalized difference between the medians for churn and not churn groups. Here are the results:</p>
<ul><ul><ul><img src="imgs/feature_relevance.png" width="600" height="400" align="center">
</ul></ul></ul>
<p>We learn from the above plot that there are three features: <code>nr_settings</code>, <code>nr_upgrades</code> and <code>songs_per_session</code>, which are very similar for the two customer groups, and consequently they do not differentiate between the churn and not churn users.</p>
<p>To get more insight in how each of the features would influence our classification task, we also look at the <a href="https://en.wikipedia.org/wiki/Kendall_rank_correlation_coefficient">Kendall rank correlation coefficient</a>. This is a correlation measure for the ordinal association between two variables. It is evaluated with the formula (see <a href="https://www.geeksforgeeks.org/python-kendall-rank-correlation-coefficient/">this blog</a> for full details):</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>&#x3C4;</mi><mo>=</mo><mfrac><mstyle mathsize="0.9em"><mrow><mi mathvariant="normal">n</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">.</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">p</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">s</mi><mtext>&#x2005;&#x200A;</mtext><mo>&#x2212;</mo><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">n</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">.</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">d</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">p</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">s</mi></mrow></mstyle><mrow><mn>0.5</mn><mo>&#x22C5;</mo><mi>n</mi><mo stretchy="false">(</mo><mi>n</mi><mo>&#x2212;</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\tau = \frac{\rm\small {nr. \; concordant \; pairs \; - \; nr. \; discordant \; pairs}}{0.5 \cdot n (n-1)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.237996em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.301996em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x22C5;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord sizing reset-size6 size5"><span class="mord mathrm">nr.</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm">concordant</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm">pairs</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathrm">nr.</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm">discordant</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm">pairs</span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> is the total number of observations. The following heatmap displays the correlations between the pairs of features in the dataset:</p>
<ul><ul><ul><img src="imgs/tau_heatmap.png" width="800" height="600" align="center">
</ul></ul></ul>
<p>There are two types of values we are looking for:</p>
<ul>
<li><em>small correlation ranks with the <code>churn</code> label:</em></li>
</ul>
<ul><ul><ul><img src="imgs/correlation_churn.png" width="800" height="500" align="center">
</ul></ul></ul>
<p>We notice that <code>avg_sess_h</code> and <code>gender</code> have the smallest correlations with <code>churn</code>. These are not exactly the same features we detected using the normalized median difference method, but those three features (<code>nr_settings</code>, <code>nr_upgrades</code> and <code>nr_songs_per_session</code>) still have rather small rank correlation coefficients with <code>churn</code>. The differences can be easily attributed to the different evaluation methods.</p>
<ul>
<li><em>high correlation ranks among pairs of features:</em></li>
</ul>
<p>We want to identify strongly correlated pairs of features, as they convey the same information to our model. Although, eliminating the extraneous features might not significantly improve the performance metrics, it will reduce the complexity of the model without sacrificing input information and it will also reduce the computation time.</p>
<p>We notice that <code>nr_songs</code>, <code>nr_playlist</code> and <code>nr_home</code> are highly correlated among each other. We can remove the last two features and keep <code>nr_songs</code>. The <code>nr_likes</code> feature produces clear splits when plotted against the other three features, indicating that churn users tend to like fewer songs, which is not entirely surprising.</p>
<ul><ul><ul><img src="imgs/correlated_pairs.png" width="800" height="500" align="center">
</ul></ul></ul>
<p>Based on this analysis, we will remove the following features before the modeling phase:</p>
<ul>
<li><code>nr_playlist</code>, <code>nr_home</code> due to high correlation with <code>nr_songs</code>,</li>
<li><code>gender</code> and <code>avg_sess_h</code> due to weak correlation with <code>churn</code>.</li>
</ul>
<p>At this point we are ready to move on to the next stage: modeling.</p>
<h2 class="mume-header" id="11-spot-check-classifiers">11. Spot Check Classifiers</h2>

<h3 class="mume-header" id="the-baseline-model">The Baseline Model</h3>

<p>It is customary to build a basic (no-skill) model that cannot discriminate between the classes and has the lowest accuracy score a model should achieve on the dataset, see this <a href="https://towardsdatascience.com/calculating-a-baseline-accuracy-for-a-classification-model-a4b342ceb88f">blog</a> for more insight into baseline models for classification. We build a <em>ZeroR</em> model, which always predicts the most numerous class (in our case the non-churn class); see this <a href="https://www.youtube.com/watch?v=kUbYN4AcPmA">video</a> for a discussion of this model. Notice that in this case the precision and thus <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">F_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>-score become undefined due to zero denominators.</p>
<p>The accuracy of the <em>ZeroR</em> model is computed on the test set as follows:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mstyle mathsize="0.9em"><mrow><mi mathvariant="normal">a</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">c</mi><msub><mi mathvariant="normal">y</mi><mstyle mathsize="0.7em"><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">t</mi><mspace width="0.3252777777777778em"></mspace><mi mathvariant="normal">s</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">t</mi></mstyle></msub><mo>=</mo><mfrac><mstyle mathsize="0.9em"><mrow><mi mathvariant="normal">n</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">t</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">c</mi><mi mathvariant="normal">h</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">n</mi></mrow></mstyle><mstyle mathsize="0.9em"><mrow><mi mathvariant="normal">a</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">l</mi><mtext>&#x2005;&#x200A;</mtext><mi mathvariant="normal">u</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">s</mi></mrow></mstyle></mfrac><mo>=</mo><mfrac><mn>5083</mn><mrow><mn>5083</mn><mo>+</mo><mn>1473</mn></mrow></mfrac></mrow></mstyle><mo>=</mo><mn>0.7753</mn></mrow><annotation encoding="application/x-tex">{\small \rm accuracy_{\rm \scriptsize test \; set} = \frac{\small \rm not \; churn} {\small \rm all \; users} = \frac{5083}{5083+1473} } = 0.7753</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.9266930000000002em;vertical-align:-0.692397em;"></span><span class="mord"><span class="mord sizing reset-size6 size5"><span class="mord mathrm">accurac</span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32839555555555555em;"><span style="top:-2.5500000000000003em;margin-left:-0.01389em;margin-right:0.05555555555555556em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size5 size2 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm sizing reset-size2 size3">test</span><span class="mspace sizing reset-size2 size3" style="margin-right:0.3252777777777778em;"></span><span class="mord mathrm sizing reset-size2 size3">set</span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter sizing reset-size5 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">all</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm">users</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">not</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm">churn</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size5 size6"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter sizing reset-size5 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathrm">5083</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathrm">1473</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathrm">5083</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693300000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size5 size6"></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0.7753</span></span></span></span></span></p>
<p>Any classifier we build must have accuracy on the test set greater that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>77.53</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">77.53 \%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">77.53%</span></span></span></span>.</p>
<p>We could also consider a more complex weak learner, such as the <em>Decision Trees (DT)</em>, as a benchmark model, as we are able to evaluate the two metrics of interest <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">F_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>-score and PR-AUC.</p>
<p>&#xA0;</p>
<h3 class="mume-header" id="the-classifiers">The Classifiers</h3>

<p>The following binary classifiers are trained with PySpark default parameters<br>
and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn></mrow><annotation encoding="application/x-tex">5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span></span></span></span>-fold cross validation on the train set.</p>
<p><strong>Logistic regression (LR)</strong> is a popular method to predict a binary categorical response using a logistic sigmoid function, which receives as input a vector of features (predictors).</p>
<p><strong>Decision Tree (DT)</strong> is an algorithm that recursively partitions the feature space in such a way that each region has separate parameters. Each partition is chosen greedily by selecting the best split from a set of possible splits, with the goal of maximizing the information gain at each tree node, see  <a href="https://spark.apache.org/docs/latest/mllib-decision-tree.html">Spark Documentation.</a></p>
<p><strong>Random Forest (RF)</strong> combines numerous decision trees with the goal of reducing overfitting. A number of decision trees are build on bootstrapped training samples. Each time a split in a tree is considered, a random sample of predictors is chosen as split candidates from the full set of predictors, see <a href="https://www.statlearning.com/">An Introduction to Statistical Learning</a> (Chp. 8).</p>
<p><strong>Gradient Boosted Trees (GBT)</strong>, uses Decision Trees as its base predictors and sequentially adds predictors to the ensemble, each one correcting its predecessor, by fitting the new predictor to the residual errors made by the previous predictors, see <a href="https://www.amazon.com/Hands-Machine-Learning-Scikit-Learn-TensorFlow/dp/1492032646">A. Geron</a> (Chp. 7).</p>
<p><strong>Multilayer Perceptron Classifier (MLPC)</strong> is a class of feedforward artificial networks. It consists of three types of layers: the input layer, the hidden layers and the output layer. Each layer is fully connected to the next layer in the network. Nodes in the input layer represent the input data, the number of input nodes should equal the number of features. The number of nodes in the output layer corresponds to the number of classes. For details on the PySpark implementation see <a href="https://spark.apache.org/docs/latest/ml-classification-regression.html#multilayer-perceptron-classifier">MLlib: Main Guide</a>.</p>
<p><strong>Linear Support Vector Machine (LSVC)</strong> constructs hyperplanes in the high dimensional features space. The best separation is achieved by the hyperplane that has the largest distance to the nearest training-data points of any class, a good presentation of this algorithm can be found in <a href="https://www.amazon.com/Hands-Machine-Learning-Scikit-Learn-TensorFlow/dp/1492032646">A. Geron</a> (Chp. 5).</p>
<p>&#xA0;</p>
<h3 class="mume-header" id="the-pipeline">The Pipeline</h3>

<p>We create a pipeline that combines all data processing steps and the classifier as the last stage:</p>
<ul>
<li>the features are split into categorical and continuous,</li>
<li>the predicted variable is identified,</li>
<li><code>StringIndexer</code> encodes the predicted variable for modeling,</li>
<li><code>VectorAssembler</code> is a transformer that combines a list of columns into a single column vector,</li>
<li><code>StandardScaler</code> standardizes the continuous features by removing the mean and scale them to unit variance using column summary statistics on the samples in the training set.</li>
</ul>
<p>&#xA0;</p>
<ul><ul><ul><img src="imgs/data_pipeline.png" width="800" height="500" align="center">
</ul></ul></ul>
<p>&#xA0;</p>
<h3 class="mume-header" id="the-first-results">The First Results</h3>

<p>For each of the classifiers discussed above we use <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn></mrow><annotation encoding="application/x-tex">5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span></span></span></span>-Fold Cross Validation, to obtain the following performance metrics on the training set:</p>
<table>
<thead>
<tr>
<th>metric</th>
<th>LR</th>
<th>DT</th>
<th>RF</th>
<th>GBT</th>
<th>MLPC</th>
<th>LSVC</th>
</tr>
</thead>
<tbody>
<tr>
<td>accuracy</td>
<td>0.869</td>
<td>0.884</td>
<td>0.872</td>
<td>0.906</td>
<td>0.873</td>
<td>0.872</td>
</tr>
<tr>
<td>precision</td>
<td>0.760</td>
<td>0.853</td>
<td>0.845</td>
<td>0.871</td>
<td>0.679</td>
<td>0.770</td>
</tr>
<tr>
<td>recall</td>
<td>0.611</td>
<td>0.584</td>
<td>0.527</td>
<td>0.680</td>
<td>0.824</td>
<td>0.615</td>
</tr>
<tr>
<td>f1_score</td>
<td>0.677</td>
<td>0.693</td>
<td>0.649</td>
<td><strong>0.764</strong></td>
<td><strong>0.744</strong></td>
<td>0.683</td>
</tr>
<tr>
<td>auc_roc</td>
<td>0.891</td>
<td>0.621</td>
<td>0.900</td>
<td>0.934</td>
<td>0.926</td>
<td>0.888</td>
</tr>
<tr>
<td>auc_pr</td>
<td>0.764</td>
<td>0.540</td>
<td>0.788</td>
<td><strong>0.867</strong></td>
<td><strong>0.848</strong></td>
<td>0.765</td>
</tr>
</tbody>
</table>
<p>&#xA0;</p>
<p>Recall that the main metrics of interest in this analysis are the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">F_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>-score (in particular the recall) and the PR-AUC.</p>
<p>We notice that the DT classifier has the weakest performance, which is to be expected as it is the weakest learner among these algorithms. The large values DT has for accuracy and precision are mostly due to the high data imbalance.</p>
<p>The trees ensemble algorithms RF and GBT perform much better. The LR and LSVC have mediocre similar performances.</p>
<p>The best performance is attained by the GBT model on almost all the metrics. The downside is, that due to its complexity, the model is very slow to train. The values attained by the MLPC model are close to the best performer&apos;s. Note that MLPC has a recall of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.824</mn></mrow><annotation encoding="application/x-tex">0.824</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0.824</span></span></span></span> as compared to GBT&apos;s recall of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.680</mn></mrow><annotation encoding="application/x-tex">0.680</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0.680</span></span></span></span>, which indicates the MLPC is better in predicting the relevant results. Of course, we see that the corresponding accuracies are in opposite relation, which in the end balance the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">F_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>-scores.</p>
<blockquote>
<p>We will fine tune both MLPC and GBT in the next stage and then evaluate them on the test set to see how they generalize.</p>
</blockquote>
<p>&#xA0;</p>
<h2 class="mume-header" id="12-fine-tune-the-best-models">12. Fine Tune the Best Models</h2>

<h3 class="mume-header" id="fine-tune-multilayer-perceptron-classifier-mlpc">Fine Tune Multilayer Perceptron Classifier (MLPC)</h3>

<p>We work with a MLPC that has layers <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>18</mn><mo separator="true">,</mo><mn>8</mn><mo separator="true">,</mo><mn>4</mn><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[18, 8, 4, 2]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">18</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">]</span></span></span></span>. The input layer contains <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>18</mn></mrow><annotation encoding="application/x-tex">18</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">18</span></span></span></span> nodes (same as the number of predicting features) and the output layer has <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span> nodes since we are dealing with binary classification. There are two hidden layers with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn></mrow><annotation encoding="application/x-tex">8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">4</span></span></span></span> nodes each. The combinations of hyperparameters that were trained is given below:</p>
<ul><ul><ul><img src="imgs/hyperpram_mlpc.png" width="420" height="100" align="center">
</ul></ul></ul>
<p>The <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>18</mn></mrow><annotation encoding="application/x-tex">18</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">18</span></span></span></span> models were trained via <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn></mrow><annotation encoding="application/x-tex">5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span></span></span></span>-fold cross validation in about <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>68</mn></mrow><annotation encoding="application/x-tex">68</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">68</span></span></span></span> minutes. The best hyperparameters found for MLPC are: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi><mi mathvariant="normal">I</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">{\rm maxIter} = 100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">maxIter</span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">100</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">k</mi><mi mathvariant="normal">S</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">z</mi><mi mathvariant="normal">e</mi></mrow><mo>=</mo><mn>128</mn></mrow><annotation encoding="application/x-tex">{\rm blockSize} = 128</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">blockSize</span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">128</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">S</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">z</mi><mi mathvariant="normal">e</mi></mrow><mo>=</mo><mn>0.01</mn></mrow><annotation encoding="application/x-tex">{\rm stepSize} = 0.01</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">stepSize</span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0.01</span></span></span></span>.</p>
<p>&#xA0;</p>
<h3 class="mume-header" id="fine-tune-gradient-boosted-trees-gbt">Fine Tune Gradient Boosted Trees (GBT)</h3>

<p>The GBT model is by far the slowest model among the ones mentioned here. Because of this inconvenience, we restricted the number of models to train, the parameter grid is given below:</p>
<ul><ul><ul><img src="imgs/hyperparam_gbt.png" width="420" height="100" align="center">
</ul></ul></ul>
<p>Even so, with only <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">4</span></span></span></span> models, and with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn></mrow><annotation encoding="application/x-tex">5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span></span></span></span>-fold cross validation, it took the cluster <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>194</mn></mrow><annotation encoding="application/x-tex">194</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">194</span></span></span></span> minutes to train. The best results were obtained for: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi><mi mathvariant="normal">I</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo>=</mo><mn>20</mn></mrow><annotation encoding="application/x-tex">{\rm maxIter} = 20</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">maxIter</span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">20</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">S</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">z</mi><mi mathvariant="normal">e</mi></mrow><mo>=</mo><mn>0.1</mn></mrow><annotation encoding="application/x-tex">{\rm stepSize} = 0.1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">stepSize</span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0.1</span></span></span></span>.</p>
<p>&#xA0;</p>
<h2 class="mume-header" id="13-model-evaluation-and-validation">13. Model Evaluation and Validation</h2>

<p>We reach the final stage in our analysis. The two best classifers&apos; hyperparameters are tuned and the models&apos; predictions on the test set (unseen data) are collected.</p>
<p>We first take a look at the raw predictions of the two models, the confusion matrix data. The test set contains <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>6556</mn></mrow><annotation encoding="application/x-tex">6556</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">6556</span></span></span></span> data points.</p>
<table>
<thead>
<tr>
<th>label</th>
<th>pred</th>
<th>--</th>
<th>GBT</th>
<th>--</th>
<th>MLPC</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>--</td>
<td>tp = 989</td>
<td>--</td>
<td>tp = 1224</td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>--</td>
<td>fp = 422</td>
<td>--</td>
<td>fp = 598</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>--</td>
<td>fn = 484</td>
<td>--</td>
<td>fn = 249</td>
</tr>
<tr>
<td>0</td>
<td>0</td>
<td>--</td>
<td>tn = 4661</td>
<td>--</td>
<td>tn = 4485</td>
</tr>
</tbody>
</table>
<p>We notice that MLPC identifies <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">p</mi></mrow><mo>+</mo><mrow><mi mathvariant="normal">f</mi><mi mathvariant="normal">p</mi></mrow><mo>=</mo><mn>1822</mn></mrow><annotation encoding="application/x-tex">{\rm tp}+{\rm fp} = 1822</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80952em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">tp</span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">fp</span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1822</span></span></span></span> users as churn, and mislabels <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">f</mi><mi mathvariant="normal">p</mi></mrow><mo>=</mo><mn>598</mn></mrow><annotation encoding="application/x-tex">{\rm fp} =598</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">fp</span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">598</span></span></span></span> users, while missing <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">f</mi><mi mathvariant="normal">n</mi></mrow><mo>=</mo><mn>249</mn></mrow><annotation encoding="application/x-tex">{\rm fn}=249</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">fn</span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">249</span></span></span></span> of the churn users. The GBT model, on the other side misses <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">f</mi><mi mathvariant="normal">n</mi></mrow><mo>=</mo><mn>484</mn></mrow><annotation encoding="application/x-tex">{\rm fn} = 484</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">fn</span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">484</span></span></span></span> users, which is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>235</mn></mrow><annotation encoding="application/x-tex">235</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">235</span></span></span></span> more users than the MLPC model. Overall, the MLPC model has the tendency to label users as churn even if the user is not-churn, while the GBT model tends to miss the churn users more often.</p>
<p>The test set specific metrics for the two models are given below:</p>
<table>
<thead>
<tr>
<th>model</th>
<th>accuracy</th>
<th>precision</th>
<th>recall</th>
<th>f1_score</th>
<th>auc_roc</th>
<th>auc_pr</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>GBT</strong></td>
<td>0.862</td>
<td>0.701</td>
<td>0.671</td>
<td>0.686</td>
<td>0.892</td>
<td>0.780</td>
</tr>
<tr>
<td><strong>MLPC</strong></td>
<td>0.871</td>
<td>0.672</td>
<td>0.831</td>
<td>0.743</td>
<td>0.930</td>
<td>0.841</td>
</tr>
</tbody>
</table>
<p>We can see from this table, that the overall scores of the MLPC model are better than of the GBT model. The MLPC model has a much better recall than the GBT model, while the latter has a better precision. But this is exactly what we observed while analyzing the confusion matrix information.</p>
<p>A look at the ROC and PR curves confirms that the MLPC model performs better than the GBT when averaging over various thresholds:</p>
<ul><ul><ul><img src="imgs/curves_best.png" width="860" height="300" align="center">
</ul></ul></ul>
<p>&#xA0;</p>
<blockquote>
<p>In conclusion, the Multilayer Perceptron Classifier is found to be the best model for this problem. Although it has the tendency to label more users as churn, this is preferable over an algorithm which tends to miss the unhappy customers.</p>
</blockquote>
<p>&#xA0;</p>
<h2 class="mume-header" id="14-justification">14. Justification</h2>

<p>An algorithm to detect the churn among the users of a fictional online music platform Sparkify was implemented. A mini sample of the data was initially analyzed in detail to gain understanding of the features and their properties. The analysis helped in engineering about <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>20</mn></mrow><annotation encoding="application/x-tex">20</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">20</span></span></span></span> new features for the model. These new features describe in detail users&apos; activity on the platform, while information on location, user&apos;s web browser and music genre preferences was not included.</p>
<p>A new dataset was build, in such a way that each row contains information for a particular user. Exploratory Data Analysis was performed on this new dataset. Several binary classification models were fitted on the train set via <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn></mrow><annotation encoding="application/x-tex">5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span></span></span></span>-fold cross validation. The two best performing models were fine tuned with Grid Search and evaluated on the test set.</p>
<p>For this project, I choose to work in PySpark and use only the classifiers that are available in its machine learning library MLlib. The visualizations were performed in Matplotlib and using Pandas. The work was done in Jupyter notebooks, both on a local machine and in AWS-EMR clusters.</p>
<p>&#xA0;</p>
<h2 class="mume-header" id="15-reflection">15. Reflection</h2>

<p>Churn detection and prediction is an interesting project, with great relevance to many businesses, and in particular online platforms. The datasets I worked with were very well chosen and relevant to the analysis.</p>
<ul>
<li>Cleaning and preprocessing data was an easy task as data is pretty clean to begin with.</li>
<li>The most interesting part was to gain understanding of the data in order to engineer new features that are relevant to the analysis.</li>
<li>I encountered numerous difficulties while configuring the AWS-EMR cluster, in installing specific versions of the Python libraries Pandas, Matplotlib and especially Seaborn. After extensive research, I found the solution via creating a virtual environment on the cluster&apos;s master node.</li>
<li>The most time consuming part was to train the Gradient Boosted Trees Classifier. I changed the cluster configuration to increase its memory and to extend the default timeout to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn></mrow><annotation encoding="application/x-tex">12</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">12</span></span></span></span>h. I also restricted the number of hyperparameters for the grid search for this algorithm.</li>
</ul>
<p>&#xA0;</p>
<h2 class="mume-header" id="16-improvement">16. Improvement</h2>

<p>There are several ways the approach could be changed to improve the performance of the classifier:</p>
<ul>
<li>Include in the analysis some of the features I omitted in the first place, such as geographical location of the user, or songs and artist preferences.</li>
<li>Examine the outliers in the features dataset, possibly remove the most extreme ones and treat the remaining outliers as hyperparameters for the model.</li>
<li>Combine the above classifiers via stacking and make predictions using a meta-classifier.</li>
<li>Use more performant classifiers such as XGBoost or LightGBM that are not implemented in PySpark MLlib library.</li>
</ul>
<h2 class="mume-header" id="17-ending-matters">17. Ending Matters</h2>

<p>The Jupyter notebooks and all the code for this project can be found in this Github repository. An extensive list of references is also included therein.</p>
<p>I would like to thank Udacity for suggesting this project and for providing the datasets. I am also grateful to the anonymous reviewer whose suggestions greatly improved the project.</p>
<p>I intend to follow with a second post in which I describe how I implemented a stacked algorithm to improve the outcome of this analysis.</p>

      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>